---
id: alkiln_writing
title: Writing ALKiln tests
sidebar_label: WIP Writing tests
slug: /alkiln/writing
---

import NeedProxyVars from './components/\_need_proxy_vars.md';
import SecureEnvVars from './components/\_secure_env_vars.md';


:::caution
WIP (Work in progress)
:::


This page describes your tests files and how to write tests <!-- , run tests, -->  and other useful information. To see the table of contents on a small screen, tap on the dropdown menu at the top of the page. To see it on a wider screen, see the column on the right-hand side of the screen.


## Do _I_ need to read this? {#who}

If you are writing tests <!-- , running tests, --> or need to learn about test files, this page is for you.


## Quick refresher {#refresh}

1. You can see [what your first test might look like](setup.mdx#first-test).
1. You can generate a more complex test with the help of the [ALKiln Story Table Step generator](https://github.com/plocket/alkiln_story).
1. If your interview is using generic objects or index variables, you **must** include [special HTML](#special-html) in your interview.
1. Every time you change or add a required variable, you must update the tests that need that variable.
1. You write and edit `.feature` test files in your Sources folder.
1. You can check the syntax of your test file by using an editor like the [editor at AssertThat](https://www.assertthat.com/online-gherkin-editor).
1. If you are using GitHub tests, those tests will run when anyone commits to GitHub.
1. By default, each Step or page **must** be completed in at most 30 seconds. You can change that with the "the maximum seconds" Step listed in the Steps.
1. ALKiln creates test reports and pictures. For example, ALKiln saves pictures and the HTML of pages that showed errors In GitHub, they are in the zip file in [your workflow's artifact section](https://docs.github.com/en/actions/managing-workflow-runs/downloading-workflow-artifacts).
1. There are some field types that ALKiln cannot yet handle, including some `object`-type fields.

<!-- The tests use the [gherkin language and syntax](https://cucumber.io/docs/gherkin/reference/) -->

Here is an example of a more complex test for a quick refresher on some of our features:

```gherkin
@children
Feature: I have children

@fast @child_benefits
Scenario: child has benefits
  Given I start the interview at "some_file_name.yml"
  And I get to the question id "benefits" with this data:
    | var | value |
    | children.there_are_any | True |
    | children.target_number | 2 |
    | children[0].name.first | Cashmere |
    | children[0].name.last | Davis |
    | children[1].name.first | Casey |
    | children[1].name.last | Davis |
  When I set the var "benefits['SSI']" to "True"
  And I tap to continue
  Then the question id should be "download"
  And I download "some_motion.pdf"
```


## Writing test Steps overview {#steps}

Most of [the code in test files](#files) is code for ALKiln Steps.

ALKiln Steps are how you give your instructions to the ALKiln robot. Steps are made of commands[^meh] that ALKiln has created for you. Those commands often need information from you. They are like fill-in-the-blank sentences. A sort of [madlibs](https://en.wikipedia.org/wiki/Mad_Libs#format) for your ALKiln robot. For example:

```gherkin
  And I set the variable "likes_bears" to "True"
```

This Step is made of three parts.

1. `And` is one of the keywords that can start a Step
1. `I set the variable "___" to "___"` is an ALKiln command with blanks that you need to fill in
1. `likes_bears` and `True` are the information you put in the blanks so that the ALKiln robot knows what answer to give to a question

That command description can also be written as `I set the variable "<variable name>" to "<value>"`. This tells you what information you should put in each of these blanks.

In this case there are two blank spaces you should fill. In the first blank, you should put the name of the variable that the field will set. In the second blank, you should put the value that you want the variable to have.

Each of your tests - [a `Scenario` or a `Scenario Outline`](#files) - usually contains many Steps. Any Step can be used as many times as you want anywhere in a test. If you follow [good code-writing practices](#choice-values), most Steps work in any language.


[^meh]: We are still working on finding a more descriptive name. Suggestions are welcome.



## Starting steps {#start}

Authors often use these Steps to start their tests, though these Steps can actually be used anytime in a test.


### `I start the interview at "<filename or url>"` {#go-to-interview}


## State steps

These steps set the context or state of the current environment.


## `the maximum seconds for each Step is <number>` {#custom-timeout}

WIP


## Interactive Steps {#interact}

You can use some Steps to change what is on the page by filling in fields, pressing buttons or tabs, or performing other actions.


### The Story Table Step {#story-table}

Use the "Story Table" Step to fill in multiple fields on multiple pages. It is the Step many of our authors work with the most. In our opinion, it is the most flexible way to fill in fields in your forms, unlike the linear ["I set" Step](#set). This makes a test easier to maintain.

<NeedProxyVars/>

You can use the [story table generator](https://plocket.github.io/alkiln_story/) to generate a first draft of a full test file that uses a Story Table based on an interview you have finished.

<!--
TODO: add an extensive instructions section to the generator. Something like:
1. If you don't have one already, [add a new test file](#how-do-i-add-a-new-test-file). You can leave out the Scenario.
1. Ensure your server config is set up to [show debug info](https://docassemble.org/docs/config.html#debug).
1. Run your interview manually until you reach the page you want the story table to get to.
1. Open the "source" display of the interview. Currently, that looks like angle brackets, `</>`, in the header of the page.
1. Note the `id` of the page.
1. Tap the "Show variables and values" button. It will open a new tab showing a big JSON object.
1. Copy all the text on that page.
1. Go to the [story table generator](https://plocket.github.io/alkiln_story/).
1. Paste the JSON into the text area there, as instructed.
1. Use the other input fields to help finalize your Scenario, including the page `id`.
1. Copy the Scenario that has been generated for you.
1. Paste that into the already prepared test file.
 -->

The Story Table Step is made of a sentence followed by a table. The data in the table is a snapshot of the user who is filling out the form. Each table row describes one fact about the user - one variable in the interview. It has this format:

```gherkin
  And I get to the question id "<target question id>" with this data:
    | var | value |
    | <variable name> | <value to set> |
    | <variable name> | <value to set> |
```

As you can see, there are three types of blanks you need to fill in for this Step: `<target question id>`, `<variable name>`, `<value to set>`. The way to use the names of variables and values to [set the values of fields](#values) is the same as the ["I set" Step](#set).

- The starting sentence **must** include the question `id`[^id] of a page in the interview.
- The table **must** include all the variables and values necessary to get a user from the current page to the page with the given question id.
- The table **must** have two columns with the headings `var` and `value`.

On each interview page, ALKiln:

1. Checks if the page has the `<target question id>` you gave it at the start
1. If the page does have the `<target question id>` it stops the Step
1. Otherwise, it looks at each `<variable name>` in the `var` column to see if it can find that name in any fields
1. For each `<variable name>` it finds, it tries to answer the field using the matching `<value to set>`
1. It tries to continue to the next page
1. If it is unable to continue it logs an error and stops
1. Otherwise, it repeats the above

An example table:

```gherkin
  And I get to the question id "brought scissors" with this data:
    | var | value |
    | last_haircut_date | today - 730 |
    | wants_virtual_haircut | True |
    | user_name | Jared |
    | intro_screen_accepts_terms | True |
```

:::tip Docs
Filling in checkboxes is tricky. Check our [documentation about setting checkbox values](#checkboxes).
:::

This Step is flexible, which makes the test easier to maintain. The order of the rows is unimportant. That means you can edit the order of your pages or move fields to different pages without worrying about breaking the test. <!-- ALKiln is also fine with extra rows that don't get used (not the same as duplicate rows). If you have duplicate rows in your test, ALKiln will warn you. -->

ALKiln sets a table variable every time it finds that variable on a page, no matter how many times that variable appears in your interview.

:::caution
Avoid using `.there_is_another` in your Story Table. Read about [what to use instead](#there-is-another).
:::

You can use multiple Story Tables in a test.

Right now, Story Tables are unable to use environment variables to fill in answers, so you cannot use them to [set sensitive information](#set-env-var) like passwords.

<!-- TODO: Why are our warnings red instead of yellow -->

:::caution Unused rows
The Story Table does not care about extra rows that never get used. This can make Story Tables easier to write, but it also means that the tests will technically "pass" even if variables that *should* get set are never filled in.

That can be a sign that a question that the user *should* have seen got skipped or that there is a typo or mistake in the test.

Because of this, the ALKiln report shows a list of unused rows for each table. You can check the report of passing tests to make sure none of the important rows got skipped.
:::

:::info
You can use this Step to [upload files](#upload).
:::


[^id]: You can find the question `id` in your interview YAML in the `question` block of that page. It is a good idea for every `question` block in your interview to have an id.


### `I set the variable "<variable name>" to "<value to set>"` {#set}

Use the "I set" Step to fill in one answer on one page. This [sets the value](#values) of that field's variable.

<!-- TODO: help wanted: This is true if they don't literally use `x` or `i`. I'm not sure how to express that complexity -->
<NeedProxyVars/>

The format of the Step:

```gherkin
  And I set the variable "<variable name>" to "<value>"
```

There are two types of blanks you need to fill for this Step. The first set of quotes in this Step contain the name of the variable you need to set. The second set of quotes contain the value you want to set. This is the same as the [Story Table's](#story-tables)'s `var` column and `value` column.

This Step is "linear". That is, unlike Story Table rows, these "linear" variable-setting Steps have to be in the correct order and you **must** make sure your test has reached the exact page that has the field. Otherwise your test will fail.

Example fields:

```yml
code: |
  users[0].favorite_bear.name.first
  users[0].favorite_bear.type
---
question: Name of your favorite bear
field:
  - Bear name: users[i].favorite_bear.name.first
  - Why is this one your favorite?: users[i].favorite_bear.why
    input type: area
---
question: Favorite bear type
field:
  - Pick one: users[i].favorite_bear.type
    datatype: radio
    choices:
      - Black bear: wild_bear
      - Brown bear: also_wild_bear
      - Teddy bear: cuddly_bear
      - Jaime: maybe_not_a_bear
```

Example linear "I set" Step:

```gherkin
  And I set the variable "users[0].favorite_bear.name.first" to "Ultraman"
  And I set the variable "users[0].favorite_bear.why" to "Why not?"
  And I tap to continue
  And I set the variable "users[0].favorite_bear.type" to "cuddly_bear"
```

:::danger Avoid!
Avoid using this Step with sensitive information, like passwords. Everyone will be able to see the information you put in this Step. Instead, [use an environment variable to set the value](#set-env-var).
:::

:::info
You can use this Step to [upload files](#upload).
:::


### `I set the variable "<variable name>" to the GitHub secret "<environment variable name>"` {#set-env-var}

Use the "secret variable" Step similar to the regular "I set" Step to fill in one answer on one page with a value. This time the value is the value of an environment variable - [a GitHub secret or docassemble server config value](#env-vars). This [sets the value](#values) of that field's variable.

You can use it to set values that have sensitive information. For example, a password. This is because ALKiln is extra careful with the security of these values.

<SecureEnvVars/>

The format of the Step:

```gherkin
  And I set the variable "<variable name>" to "<environment variable name>"
```

Here, `<variable name>` is the name of the variable you want to set and `<environment variable name>` is the name of the environment variable you want to use.

Example:

```gherkin
  I set the variable "user_account_password" to the GitHub secret "USER1_PASSWORD"
```

The words of this Step assume you use GitHub for your tests and are using a GitHub secret to store the value, but this Step also works with config values you create for ALKilnInThePlayground. You can [read more about environment variables here](#env-vars).

You can use this Step for more than just sensitive information. You can also use environment variables for values that might change sometimes so that you can use the value in multiple places and then only have to manage the value change in one place. For example, if you have a date you want to set in multiple tests or repositories that you will want to update in all the tests at once, you can use an environment variable instead of manually updating everywhere the date appears.

<!-- To learn how to create and add a secret for the test, see the [GitHub secrets section](#github-secrets). -->

:::caution
This Step is unable to sign into your docassemble server. You **MUST** use [the "log in" Step](#sign-in) to sign in to your docassemble server.
:::

<!-- TODO: Maybe put env var stuff in here, but we do also need that info for other things, like workflows -->


### I tap to continue {#continue}

Use the "continue" Step to tap the button to continue to the next page. If the continue button sets a variable, this Step will set that variable to `True`. Story Table Steps handle continuing by themselves.

Example:

```gherkin
  When I tap to continue
```

The test will still continue to the next Step if tapping the continue button fails to go to the next page. Because of this, you can then use the ["invalid" Step](#invalid) to write tests that check that your answer validation works correctly. However, if the continue button was supposed to work and the next Step tries to interact with the next page, the test will probably fail.

<!-- If the fields are the same on both pages, the test will continue to run, though. In some cases, it might also repeat the page over and over. This is an [infinite loops](#infinite-loop). -->


<!-- ### `I upload "<file or files>" to "<variable name>"` {#upload-step} not necessary anymore. deprecated -->


### `I set the name of "<variable name>" to "<name>"` {#name}

The "name" Step is specifically for the Document Assembly Line 4-part name questions.

Avoid punctuation. We recommend you just use 2 names - the first name and last name - but you can have all these formats:

- Firstname Lastname
- Firstname Middlename Lastname
- Firstname Middlename Lastname Suffix (where suffix is one of the dropdown suffix choices, like `II`)

```gherkin
  And I set the name of "users[0]" to "Devon Upton"
```


### `I set the address of "<variable name>" to "<US address>` {#address}

The "address" Step is specifically for the Document Assembly Line 4-part address questions. Right now, **the "address" Step can only handle the format of a US address**.

```gherkin
    When I set the address of "users[0]" to "120 Tremont Street, Unit 1, Boston, MA 02108"
```

Remember the commas.


### `I download "<file name>"` {#download}

Use the "download" Step to download files so that humans can check that they are correct. In GitHub after the tests are all done, the files will be in the GitHub action's artifacts zip file.

<!-- TODO: link to test results section -->

```
    Then I download "file-name.pdf"
```

Use just the name of the file.

If the file is a PDF file, you can use the ["compare files" Step](#compare-files) to check that the PDF is correct.

If you think this Step will take more than 30 seconds, use the ["max seconds" Step](#custom-timeout) to give the file more time to download.


### `I tap the "<selector>" element and go to a new page` {#tap-nav-element}

**It could help to know about:**

- How to inspect and understand the HTML of a web page
- CSS selectors

**The Step:**

Use one of the "tap and navigate" Steps to tap an element on the page, like a button, to go to a new page. If you just want to tap the continue button use the ["continue" Step](#continue).

The format for option 1:

```gherkin
  And I tap the "<selector>" element and go to a new page
```

The format for option 2:

```gherkin
  And I tap the "<selector>" element and wait <number> seconds
```

One blank to fill in for these commands is `<selector>`, a CSS selector of the element you need to tap. It can be any valid [CSS Selector](https://developer.mozilla.org/en-US/docs/Learn/CSS/Building_blocks/Selectors).

For option 2, the second blank to fill in is `<number>` - the number of seconds you want ALKiln to wait after tapping the element.

Example of option 1:

```gherkin
  When I tap the "#awesome_page_link" element and go to a new page
```

Example of option 2:

```gherkin
  And I tap the ".link-container #even_better_page a" element and wait 45 seconds
```

This is the only way to explicitly wait after navigating to the new page. Some people try to use the ["wait" Step](#wait), but that will fail. Alternatively, you can use the ["max seconds" Step](#custom-timeout) to give your test more time to load new pages in general.


### `I tap the "<selector>" element and stay on the same page` {#tap-stay-element}

**It could help to know about:**

- How to inspect and understand the HTML of a web page
- CSS selectors

**The Step:**

Use the "tap and stay" Step to tap on HTML elements without navigating to a new page. For example, you can tap on [collapsible content](https://suffolklitlab.org/docassemble-AssemblyLine-documentation/docs/framework/altoolbox#collapsible-help-text) to show the text inside.

The format:

```gherkin
  And I tap the "<selector>" element and stay on the same page
```

The blank to fill in for this command is `<selector>`, a CSS selector of the element you need to tap. It can be any valid [CSS Selector](https://developer.mozilla.org/en-US/docs/Learn/CSS/Building_blocks/Selectors).

Example:

```gherkin
  When I tap the "#an_id .al_toggle" element and stay on the same page
```

It is a good idea to add a [`wait` Step](#wait) after this Step to let the contents become visible before taking other actions, like pressing on other elements or checking for a phrase. For example:

```gherkin
  When I tap the "#an_id .al_toggle" element and stay on the same page
  And I wait .7 seconds
```


### `I tap the "<tab id>" tab` {#tap-tab}

**It could help to know about:**

- How to inspect and understand the HTML of a web page

**The Step:**

Use the "tap tab" Step to interact with AssemblyLine's [ALToolbox tabs](framework/altoolbox.md#display-a-series-of-tabs). ALKiln will tap on the tab and then wait until the tab contents are fully visible.

The format:

```gherkin
  When I tap the "<tab html id>" tab
```

The blank to fill in here is `<tab html id>` - the text of the HTML id attribute of the tab.

:::caution Not a selector
`<tab html id>` is **not a selector**. Unlike the other "tap" Steps, **leave out the `#` symbol** (like the example shows).
:::

Example:

```gherkin
  When I tap the "TabGroup-specific_tab_name-tab" tab
```


### Environment variables {#env-vars}

WIP


## Steps to start tests {#start}

There are some Steps that can be, and often are, the first Step in a test. They can still be used multiple times and at any point in the test. Your test **must** start with one of these Steps.

WIP


### `I start the interview at "<YAML file name>"` {#start-interview}

Use this Step to start a new session of an interview.

### `I sign in with the email "<environment variable 1>" and the password "<environment variable 2>"` {#sign-in}

WIP


### `The maximum time for a Step is <number> seconds` {#custom-timeout}

WIP


### `I wait for <number> seconds` {#wait}

WIP


## Setting values {#values}

There are different ways to fill in fields. One is the [Story Table Step](#story-table) another is the ["I set" Step](#set). Each has different syntax, but they set values the same way.

<NeedProxyVars/>

Be sure to use the actual `value` of the field, not just the text that the user sees. For example, for the first choice in this field the `value` would be "wild_bear", not "Black bear". "Black bear" is just the text the user sees - the label.

```yml
question: Favorite bear type
field:
  - Pick one: users[i].favorite_bear.type
    datatype: radio
    choices:
      - Black bear: wild_bear
      - Brown bear: also_wild_bear
      - Teddy bear: cuddly_bear
      - Jaime: maybe_not_a_bear
```


### Special HTML {#special-html}

**What?**

Most authors add this extra HTML to the `post` section of their `default screen parts`. For example:

```yml
default screen parts:
  # HTML for interviews using ALKiln tests
  # If your interview includes AssemblyLine's al_package.yml you can skip this
  post: |
    <div id="alkiln_proxy_var_values"
    data-generic_object="${ encode_name(str( x.instanceName if defined('x') else '' )) }"
    % for letter in [ 'i', 'j', 'k', 'l', 'm', 'n' ]:
    data-index_var_${ letter }="${ encode_name(str( value( letter ) if defined( letter ) else '' )) }"
    % endfor
    aria-hidden="true" style="display: none;"></div>

    <div id="trigger" data-variable="${ encode_name(str( user_info().variable )) }" aria-hidden="true" style="display: none;"></div>
```

AssemblyLine's al_package.yml file, if you use it, already adds that HTML for you. Otherwise, we strongly recommend adding it yourself as the docs described.

**Do I need this?**

You probably need the "alkiln_proxy_var_values" HTML element if you use [generic objects](https://docassemble.org/docs/fields.html#generic) (`x`) or [index variables](https://docassemble.org/docs/fields.html#index%20variables) (`i`, `j`, `k`, etc) in your interview.

You probably need the "trigger" HTML element if you set `restrict input variables` to `True` in your [docassemble server configuration file](https://docassemble.org/docs/config.html#configfile).

**Why `x` and `i`?**

Without the help of the HTML, ALKiln has no way of knowing what the actual names are of variables that use [generic objects](https://docassemble.org/docs/fields.html#generic) (`x`) or [index variables](https://docassemble.org/docs/fields.html#index%20variables) (`i`, `j`, `k`, etc).

**Why "trigger"?**

If a docassemble server's config value of `restrict input variables` is set to True, ALKiln needs the help of the HTML to know what variable the signature is setting.

That said, even the "trigger" HTML may not help if the question is triggered by `mandatory: True`.


### Text {#text}

Text-type fields are fields where the user needs to type text. The [default field type](https://docassemble.org/docs/fields.html#plaintext) is a text field. Other text fields include those with:

- `datatype: date`
- `datatype: time`
- `datatype: currency`
- `datatype: password`
- `datatype: email`
- `datatype: phone`
- `datatype: text`
- `datatype: integer`
- `datatype: number`
- `input type: area` accept text for their value.

You can see more [about `datatype`s and `input type`s in the docassemble docs](https://docassemble.org/docs/fields.html#data%20types).

Example text fields:

```yml
question: Name of your favorite bear
field:
  - Bear name: users[i].favorite_bear.name.first
  - Why is this one your favorite?: users[i].favorite_bear.why
    input type: area
```

Example linear Steps:

```gherkin
  And I set the variable "users[0].favorite_bear.name.first" to "Ultraman"
  And I set the variable "users[0].favorite_bear.why" to "Why not?\nSeems ok to like Ultraman."
```

Example Story Table Step:

```gherkin
    | var | value |
    | users[0].favorite_bear.name.first | Ultraman |
    | users[0].favorite_bear.why | Why not?\nSeems ok to like Ultraman. |
```


### Dates {#dates}

Dates are a specific kind of text value. ALKiln expects the format ##/##/####. For example, 06/26/2015. For [Assembly Line custom three-parts date fields](../framework/altoolbox#birthdate-and-threepartsdate-custom-data-types), ALKiln will assume the date format is dd/mm/yyyy.

There is also [a special ALKiln value named `today`](#today).


### Today {#today}

One special ALKiln value you can include is `today`. That will insert the date on which the test is being run. You can also subtract from, or add days to, `today`.

Example linear Steps:

```gherkin
  And I set the value "signature_date" to "today"
  And I set the value "court_date" to "today + 20"
  And I set the value "minors_birth_date" to "today - 3650"
```

Example Story Table Step:

```gherkin
    | signature_date | today |
    | court_date | today + 20 |
    | minors_birth_date | today - 3650 |
```

The last example makes sure that the date is 10 years in the past, ensuring that a minor always stays a minor for that test.

:::caution Be careful
Be careful with `today` math. If you are testing a "boundary" date, you want to pick a date that is well within a boundary to make the test more robust. For example, if you want to test a date that was 10 or fewer days ago, use `today - 9` instead of `today - 10`.

At some point your tests might run over night and hit midnight right in the middle of the test - after ALKlin fills in the answer, but before the interview finishes. In that situation, if ALKiln answered the question with `today - 10` the clock would tip into the next day by the end of the interview - 11 days from the filled-in date. Your test would fail incorrectly.

The fact is, your users also might have that exact experience, so keep that in mind as you design your interview. For example, instead of just telling a user that they are or are not eligible, you can tell them the date of the deadline so they too will know about the boundary.
:::


### yesno {#yesno}

There are a few different `yesno` fields - [`yesno` buttons](https://docassemble.org/docs/fields.html#yesno) or [`yesno` fields](https://docassemble.org/docs/fields.html#fields%20yesno) like `yesno` checkboxes and `yesnoradio`s.

Example yesno checkbox field:

```yml
question: Bears
field:
  - Do you have any bears?: has_bear
    datatype: yesno
```

Example of setting the yesno checkbox to "yes" in a linear Step:

```gherkin
  When I set the variable "has_bear" to "True"
```

Example of setting the yesno checkbox to "yes" in a Story Table Step:

```gherkin
    | var | value |
    | has_bear | True |
```


### yesnomaybe {#yesnomaybe}

There are a couple different `yesnomaybe` fields - [`yesnomaybe` buttons](https://docassemble.org/docs/fields.html#yesnomaybe) and [`datatype: yesnomaybe`](https://docassemble.org/docs/fields.html#fields%20yesno) fields.

Example yesnomaybe field:

```yml
question: Bears
field:
  - Do you have any bears?: has_bear
    datatype: yesnomaybe
```

Example of setting the yesnomaybe radio buttons to "maybe" in a linear Step:

```gherkin
  When I set the variable "has_bear" to "None"
```

Example of setting the yesnomaybe radio buttons to "maybe" in a Story Table Step:

```gherkin
    | var | value |
    | has_bear | None |
```


### radio {#radio}

Example radio button field:

```yml
question: Favorite bear type
field:
  - Pick one: users[i].favorite_bear.type
    datatype: radio
    choices:
      - Black bear: wild_bear
      - Brown bear: also_wild_bear
      - Teddy bear: cuddly_bear
      - Jaime: maybe_not_a_bear
```

:::tip Good practice
Always use options that have [both a label and a value](#choice-values).
:::

Example linear Step:

```gherkin
  When I set the variable "users[0].favorite_bear.type" to "cuddly_bear"
```

Example Story Table Step:

```gherkin
    | var | value |
    | users[0].favorite_bear.type | cuddly_bear |
```


### checkboxes {#checkboxes}

<!-- Maybe this section should go in the "I set the var" section and/or the Story Table section. It might need to be in all three places. This is such a common problem. If we didn't have to account for `False`, I'd say ALKiln should handle the way everyone seems to intuitively set checkboxes -->

Many authors find setting checkboxes confusing and often accidentally use an incorrect variable name or value. When they do that, they can get a ["variable not found" error](troubleshooting.mdx#variable-not-found) or an ALKiln Story Table Step might just skip the field. Reading this section can help.

:::tip Advanced summary
- The only value a checkbox can have is `True` or `False`.
- In ALKiln, the variable name of the checkbox is usually the same as its docassemble variable name. For example, `good_fruits['Apples']`.
- The names of `object_checkboxes` variable names in ALKiln are similar to how docassemble uses them, but they have extra quotes inside the first square brackets. For example: `best_friends['all_friends[0]']`
:::

An example of a checkbox field:

```yml
fields:
  - Out of all your friends, choose your best friends: best_friends
    datatype: checkboxes
    choices:
      - Emmet: emmet
      - Maria: maria
      - Sam: sam
```

:::tip Good practice
Always use options that have [both a label and a value](#choice-values).
:::

The variable name of the checkbox for ALKiln is usually the same as its docassemble variable name. For example, `good_fruits['Apples']`. The only value a checkbox can have is `True` or `False`.

:::danger Wrong
```gherkin
  And I set the variable "best_friends" to "Emmet"
```
:::

:::tip Right
```gherkin
  And I set the variable "best_friends['Emmet']" to "True"
```

or, in a Story Table:

```gherkin
      | var | value |
      | best_friends['Emmet'] | True |
```
:::

One exception is field created with an `object` datatype, like `object_checkboxes`. Their ALKiln names are similar to their docassemble names, but they need extra quotes. For example, look at this field:

```yml
fields:
  - Out of all your friends, choose your best friends: best_friends
    datatype: object_checkboxes
    choices: all_friends
```

:::danger Wrong
```gherkin
  And I set the variable "best_friends" to "all_friends"
  And I set the variable "best_friends" to "all_friends[0]"
  And I set the variable "best_friends[all_friends[0]]" to "True"
```
:::

:::tip Right
```gherkin
  And I set the variable "best_friends['all_friends[0]']" to "True"
```

or, in a Story Table:

```gherkin
    | var | value |
    | best_friends['all_friends[0]'] | True |
```
:::

:::caution Eagle eye
Especially notice the quotes just inside the first square brackets.
:::


### Upload {#upload}

You can upload one or more files by setting a variable to a comma-separated list of file names to upload. You **must** store files that you plan to upload in your ["Sources" folder](https://docassemble.org/docs/playground.html#sources) along with your tests.

The format for a linear Steps:

```gherkin
  And I set the variable "<variable name>" to "<comma separated list of a file or files>"
```

The format for a Story Table Step:

```gherkin
    | var | value |
    | <variable name> | <comma separated list of a file or files> |
```

Example of a linear Step to upload 1 file:

```gherkin
  And I upload "refutable_evidence.jpg" to "evidence_files"
```

Example of a linear Step to upload multiple files:

```gherkin
  And I upload "irrefutable_evidence.jpg, refutable_evidence.pdf" to "evidence_files"
```

Example of a Story Table Step to upload 1 file:

```gherkin
    | var | value |
    | evidence_files | refutable_evidence.jpg |
```

Example of a Story Table Step to upload multiple files:

```gherkin
    | var | value |
    | evidence_files | irrefutable_evidence.jpg, refutable_evidence.pdf |
```

To upload more than one file you **must** separate their names with a comma.


### signature {#signature}

<!-- TODO: Move this to the appropriate Steps section when that's ready. Leave a link here? -->

Signatures look a bit funny in ALKiln at the moment, but they work fine.

Example of a docassemble [signature page](https://docassemble.org/docs/fields.html#signature):

```yml
question: Sign your name
signature: user.signature
under: ${ user }
```

Example of linear Steps:

```gherkin
  And I sign
  # or
  And I sign with the name "<signatory's name>"
```

The first version will show a single dot as the signature. The second version will show the name and also have a dot.

In a Story Table, a signature variable has nothing in its `value` column. Example of a Story Table Step:

```gherkin
    | var | value |
    | user.signature |  |
```

All Story Table signatures are a single dot.


### `.there_is_another` loop {#there-is-another}

In a Story Table, setting the value of `.there_is_another` for a docassemble loop is more complicated than you might expect. At first glance, to fill in the answers for two children some authors try to write the following:

:::danger Wrong
```gherkin
    | var | value |
    | kids.there_are_any | True |
    | kids.there_is_another | True |
```
:::

Instead of using `.there_are_any` and `.there_is_another`, always use `.target_number` in their place to set the number of items that you want to include in the test.

:::tip Right
For 3 children:

```gherkin
    | var | value |
    | kids.target_number | 3 |
```

For no children:

```gherkin
    | var | value |
    | kids.target_number | 0 |
```
:::


### others {#other-values}

WIP


<!-- ### Special values {#special-values}

`today` is a special value in ALKiln. ALKiln will change that value into the date of the current day. Right now it uses the US format for the date. You can also add or subtract days from `today` to set a specific date in the past or in the future. These are the ways you can use `today`:

```gherkin
    | signature_date | today |
    | court_date | today + 20 |
    | minors_birth_date | today - 3650 |
```

The last example makes sure that the date is 10 years in the past, ensuring that a minor always stays a minor for that test.
 -->


## Observational Steps {#observe}

You can use some Steps to look at what is on the page or compare data. You can use these to make sure the interview has done what you want it to.


### `I SHOULD see the phrase "<page text>"` {#phrase}

WIP


### `I will be told an answer is invalid` {#invalid}

WIP


### Compare {#compare-files}

WIP

You can compare example PDFs (sometimes called a baseline) to downloaded PDFs to make sure they're the same. The baseline PDF must be stored in your ["Sources" folder](https://docassemble.org/docs/playground.html#sources) along with your tests, and the downloaded PDF should have been downloaded by the above step (`Then I download "download.pdf"`) earlier in the same scenario.

```
  Then I expect the baseline PDF "baseline.pdf" and the new PDF "download.pdf" to be the same
```

This will compare all of the text in the baseline PDF with all of the text in the newly downloaded PDF, and then it'll compare the fillable fields of each. If anything is different, it will print out what differed in the report. You can use that info and search for the differing text in the baseline PDF and in the download PDF in [the artifacts](#see-github-test-results) to see how they differ.


## Understanding test results {#output}

WIP


## Test file anatomy {#files}

Your tests files have the code that tells ALKiln how to answer questions in your interview and do other things. The code may look different than other code you have seen, but it is still code. It is still rigid and needs you to use the right syntax and spelling.

You should save your test files in your package's ["Sources" folder](https://docassemble.org/docs/playground.html#sources). If you used the ALKiln setup interview, there will already be a test there that just loads the interview.

In test files, you use [Gherkin](https://cucumber.io/docs/gherkin/) syntax and keywords[^keywords] with [specific "Steps" that the ALKiln framework has created](#steps) for docassemble interviews.

[^keywords]: Keywords are specific words that have a special meaning and purpose when you use them in specific places in your test code. They are similar to the words `else` and `not` in python.

Here are some rules about test files:

- You can have as many test files as you want.
- Each file can have one or more tests, called Scenarios or Scenario Outlines.
- Each file's name **must** end in `.feature` because that is the extension of that type of file. For example, `user_has_children.feature`.
- Each file **must** start with the keyword `Feature:` or a tag followed by a new line and the `Feature:` keyword.
- Each file **must** contain only one `Feature:` keyword.
- You **must** use **Gherkin** syntax for your tests. [Gherkin's own documentation](https://cucumber.io/docs/gherkin/reference/) is the best place to read about Gherkin syntax with some exceptions that you can read below. Ignore notes about "step definitions". Those are part of what ALKiln takes care of.

To troubleshoot Gherkin synatx problems <!-- TODO: Add link to errors that indicate incorrect syntax. Wrong cell count, etc. --> in your tests, use an editor like the one at [AssertThat](https://www.assertthat.com/online-gherkin-editor). It will mark lines that have incorrect syntax. For example, the editor should mark an extra `Feature:` keyword as incorrect.

ALKiln only allows you to use some Gherkin keywords. Those are:

- [`Feature:`](https://cucumber.io/docs/gherkin/reference/#feature) - each file can only use one `Feature:` keyword.
- [`Scenario:`/`Example:`](https://cucumber.io/docs/gherkin/reference/#example) - We recommend you use `Scenario`. **Make the `Scenario` descriptions unique** because ALKiln will use them in the names of the reports it creates for you. This keyword is different from the plural `Examples`/`Scenarios`.
- [`Scenario Outline:`](https://cucumber.io/docs/gherkin/reference/#scenario-outline)
- [`Examples:/Scenarios:`](https://cucumber.io/docs/gherkin/reference/#examples) - We recommend you use `Examples`. This can help you test translations, as shown below. When a `Scenario Outline` has an `Examples` table, the test will run at least once for each row in the table. This keyword is different from the singular `Scenario`/`Example`.
- Theses keywords that can start a Step - [`Given`](https://cucumber.io/docs/gherkin/reference/#given), [`When`](https://cucumber.io/docs/gherkin/reference/#when), [`Then`](https://cucumber.io/docs/gherkin/reference/#then), and [`And`](https://cucumber.io/docs/gherkin/reference/#and).

ALKiln also lets you use:

- `@` ([Tags](https://cucumber.io/docs/cucumber/api/?lang=java#tags)). The specific sections of the tags documentation that apply to ALKiln are:
  - A [general description of tags](https://cucumber.io/docs/cucumber/api/?lang=java#tags).
  - [Tag expressions](https://cucumber.io/docs/cucumber/api/?lang=java#tag-expressions)
  - Extra: [Tag inheritance](https://cucumber.io/docs/cucumber/api/?lang=java#tag-inheritance).
- `#` (Comments). They are a tiny bit different than python comments. They always have to be on their own line. The line can begin with zero or more spaces. You can use comments anywhere in your test file.
- `|` ([Data tables](https://cucumber.io/docs/gherkin/reference/#data-tables)).
- `"""` ([Doc strings](https://cucumber.io/docs/gherkin/reference/#doc-strings)).

We usually write test text as if it is from the perspective of the user. For example, "I wait" and "I start".

Here is an example of a file that uses most of these features. The name of this file is `children.feature`.

``` gherkin
@has_children
Feature: I have children

# This Scenario uses the Story Table Step. It lets you list the names of
# the variables in any order you want.
@disallow_visitation
Scenario: I disallow visitation
  Given I go to the interview at "protective_order.yml"
  And I get to the question id "what kind of visitation?" with this data:
    | var | value |
    | needs_allow_visitation | False |
    | user_name | Jordan |
    | user_has_children | True |
  Then I should see the phrase "Jordan"

# This test will run once for each row in the `Examples` table. The text
# between the "<" and ">" is the name of a column in the `Examples` table.
@allow_visitation
Scenario Outline: I allow visitation
  Given I go to the interview at "<url>"
  Then I should see the phrase "<name>"
  When I set "user_name" to "Rea"
  And I tap to continue
  Then I should see the phrase "<greeting> Rea!"
  And I set "user_has_children" to "True"
  And I tap to continue
  When I set "needs_allow_visitation" to "True"
  Then I should see see the phrase "This form can help you with that"

  Examples:
    | url | name | greeting |
    | protective_order.yml | Your name | Hello |
    | protective_order.yml&lang=es | Tu nombre | Hol√° |
```


<!--
Does this section need more details?

Each file has
...
1. One or more `Scenario` or `Scenario Outline` keywords followed by a colon (`:`) and a space and then a short text description of the purpose of that specific test.

Feature
Each `Feature` keyword **must** be followed by a colon (`:`) and a space and then a short text description of the purpose of the tests in the file. For example, `Feature: The user has children`.
Each `Feature` can have zero or more **tags** on the line above it.

Scenario
Each `Scenario` **must** have one or more **Steps**.
Each `Scenario` can have zero or more **tags** on the line above it.

Scenario Outline
1. Can have zero or more `Examples` tables. (Can it really have multiple `Examples`? If so, we should warn that this will cause tons of tests because the number of tests is factorial or something like that.)

Each **Step** **must** start with one of these keywords:
1. `Given`
1. `Then`
1. `When`
1. `And`
You can use any of those. It does not matter what you pick.
 -->


## Running tests {#run}

<!--
### Only run some tests.
  Only run one test with tags. Here or in setup in the future section about running tests?
-->

WIP


## Tips {#tips}

<!-- Something about unused rows? -->

### Values of choices {#choice-values}

WIP

<!-- Be sure to use the actual `value` of the field, not just the text that the user sees. For example, for the first choice in this field the `value` would be "wild_bear", not "Black bear". "Black bear" is just the text the user sees - the label.

```yml
question: Favorite bear type
field:
  - Pick one: users[i].favorite_bear.type
    datatype: radio
    choices:
      - Black bear: wild_bear
      - Brown bear: also_wild_bear
      - Teddy bear: cuddly_bear
      - Jaime: maybe_not_a_bear
``` -->

```gherkin
fields:
  - Q1: var_1
    datatype: radio
    choices:
      - Apples
      - Oranges
# vs
fields:
  - Q1: var_1
    datatype: radio
    choices:
      - Apples: Apples
      - Oranges: Oranges
```

Do the latter.


## Frequently asked questions (FAQ) {#faq}


### Do I have to set every variable in the interview? {#every-var}

No, only required variables.
